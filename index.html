<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Camp Bull ‚Äî 3D (fixed)</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
<style>
  :root{ --panel-w: 1040px; --panel-h: 680px; }
  body{ font-family:'Inter',sans-serif; background:#0b1020; color:#e2e8f0;
        display:flex; align-items:center; justify-content:center; min-height:100vh; margin:0; }
  #screen{ width:100%; max-width:var(--panel-w); min-height:var(--panel-h);
           background:#1f2937; border-radius:12px; padding:16px; position:relative; box-shadow:0 8px 24px rgba(0,0,0,.35);}
  #three-root{ width:100%; height:620px; background:#0f172a; border-radius:8px; overflow:hidden; position:relative; }
  .hud{ position:absolute; z-index:10; pointer-events:none; }
  #hud-left{ top:18px; left:18px; display:flex; gap:8px; flex-direction:column; pointer-events:auto;}
  #hud-left .bar-row{ display:flex; align-items:center; gap:8px; }
  .bar{ width:160px; height:18px; border-radius:10px; background:#485164; overflow:hidden; border:1px solid #65708a;}
  .fill{ height:100%; transition:width .25s; }
  #coins{ position:absolute; bottom:18px; left:18px; pointer-events:auto;
          background:#1f2937; padding:8px 12px; border-radius:8px; display:flex; align-items:center; gap:6px; }
  #user-id{ opacity:.55; font-size:12px; }
  #cabin-score{ position:absolute; top:18px; right:18px; background:#1f2937; padding:10px 12px; border-radius:8px; pointer-events:auto;}
  #event-banner{ position:absolute; top:18px; left:50%; transform:translateX(-50%);
                 background:#0b5; color:#02140b; padding:6px 12px; border-radius:8px; display:none; font-weight:700;}
  #quest-box{ position:absolute; bottom:18px; right:18px; background:#1f2937; padding:10px 12px; border-radius:8px; max-width:280px; }
  #chat{ position:absolute; bottom:18px; left:50%; transform:translateX(-50%); width:40%;
         background:#111827; border:1px solid #2a3243; border-radius:10px; overflow:hidden; pointer-events:auto; }
  #chat-log{ height:120px; overflow:auto; padding:8px 10px; font-size:14px; }
  #chat input{ width:100%; outline:none; border:none; padding:10px; background:#0b1225; color:#e2e8f0; font-size:14px; }
  .btn{ padding:8px 12px; border-radius:8px; background:#2563eb; color:#fff; font-weight:700; }
  #screens{ display:none; }
  #cutscene, #cabins { display:none; align-items:center; justify-content:center; gap:16px; }
  #top-row{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;}
  #shop-tip{ position:absolute; right:50%; top:50%; transform:translate(390px,-210px);
             background:#1f2937; padding:8px 10px; border-radius:8px; font-size:12px; opacity:.9;}
</style>
</head>
<body>
  <div id="screen">
    <div id="top-row">
      <div class="text-xl font-bold">Camp Bull</div>
      <div id="user-id"></div>
    </div>

    <div id="screens">
      <div id="loading" class="text-center text-lg">Loading Camp Bull‚Ä¶</div>

      <div id="cutscene" class="flex flex-col text-center">
        <img src="https://placehold.co/640x260/60a5fa/ffffff?text=Bus+to+Camp" class="rounded mb-4" alt="">
        <p class="opacity-90">You arrive at Camp Bull. Pines sway. A lake glitters. Time to pick your cabin.</p>
        <button id="to-cabins" class="btn inline-block mt-3">Continue</button>
      </div>

      <div id="cabins" class="flex flex-col">
        <div class="text-2xl font-bold mb-3">Choose your Cabin</div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap:3">
          <button class="btn" data-cabin="Bobcat">Bobcat ‚Äî Agile</button>
          <button class="btn" data-cabin="Eagle">Eagle ‚Äî Soaring</button>
          <button class="btn" data-cabin="Bull">Bull ‚Äî Strong</button>
          <button class="btn" data-cabin="Bass">Bass ‚Äî Wise</button>
          <button class="btn" data-cabin="Cheetah">Cheetah ‚Äî Fast</button>
        </div>
      </div>
    </div>

    <div id="three-root" aria-label="3D world"></div>

    <!-- HUD -->
    <div id="event-banner" class="hud">Event: Heat Wave ‚Äî Thirst drains faster</div>

    <div id="hud-left" class="hud">
      <div class="bar-row"><span>üçî Hunger</span><div class="bar"><div id="hunger" class="fill" style="width:100%;background:#ef4444"></div></div></div>
      <div class="bar-row"><span>üíß Thirst</span><div class="bar"><div id="thirst" class="fill" style="width:100%;background:#3b82f6"></div></div></div>
      <div class="bar-row"><span>üöΩ Bathroom</span><div class="bar"><div id="bathroom" class="fill" style="width:0%;background:#22c55e"></div></div></div>
    </div>

    <div id="coins" class="hud"><span>üí∞</span><b id="coin-val">0</b><span>Bull Coins</span></div>

    <div id="cabin-score" class="hud">
      <div class="font-bold mb-1">Cabin Rivalry</div>
      <div id="score-list" class="text-sm space-y-1"></div>
    </div>

    <div id="quest-box" class="hud">
      <div class="font-bold">Quest</div>
      <div id="quest-text" class="text-sm opacity-90">‚Äî</div>
    </div>

    <div id="shop-tip" class="text-sm hidden">Shop üõí: Press <b>E</b> to buy (Snack=5, Water=3)</div>

    <div id="chat">
      <div id="chat-log"></div>
      <input id="chat-input" placeholder="Press Enter to chat (throttled)‚Ä¶"/>
    </div>
  </div>

  <!-- Three.js + Game -->
  <script type="module">
    import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js";
    import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js";

    // Firebase (optional/online)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, getDoc, updateDoc, addDoc, serverTimestamp, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Config / Globals ---
    const firebaseConfig = JSON.parse(typeof window.__firebase_config !== 'undefined' ? window.__firebase_config : '{}');
    const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
    const initialAuthToken = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : null;
    const ONLINE = Boolean(firebaseConfig && firebaseConfig.apiKey);

    let app, db, auth, userId = 'offline-' + Math.random().toString(36).slice(2,8);
    const basePath = `artifacts/${appId}/public/data`;
    const playersCol = `${basePath}/players`;
    const cabinsDocPath = `${basePath}/meta/cabinScores`;
    const chatCol = `${basePath}/chat`;

    const cabinColors = { Bobcat:'#ff7f00', Eagle:'#3498db', Bull:'#c0392b', Bass:'#27ae60', Cheetah:'#f1c40f' };

    // --- UI refs ---
    const root = document.getElementById('three-root');
    const userIdEl = document.getElementById('user-id');
    const eventBanner = document.getElementById('event-banner');
    const hungerEl = document.getElementById('hunger');
    const thirstEl = document.getElementById('thirst');
    const bathroomEl = document.getElementById('bathroom');
    const coinsEl = document.getElementById('coin-val');
    const scoreList = document.getElementById('score-list');
    const questText = document.getElementById('quest-text');
    const shopTip = document.getElementById('shop-tip');
    const chatLog = document.getElementById('chat-log');
    const chatInput = document.getElementById('chat-input');

    // Simple screen flow
    const screens = {
      wrapper: document.getElementById('screens'),
      loading: document.getElementById('loading'),
      cutscene: document.getElementById('cutscene'),
      cabins: document.getElementById('cabins'),
    };
    function show(id){
      screens.wrapper.style.display = 'block';
      for (const key of ['loading','cutscene','cabins']) screens[key].style.display='none';
      screens[id].style.display = 'flex';
    }

    // --- Player State ---
    let player = {
      id:userId, username:`Camper_${Math.floor(Math.random()*10000)}`,
      cabin:null, x:0, z:0, rot:0,
      bullCoins:20, hunger:100, thirst:100, bathroom:0,
    };
    const others = {}; // id -> {mesh, state}

    // --- Three.js scene ---
    const scene = new THREE.Scene();
    const renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.shadowMap.enabled = true;
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    root.appendChild(renderer.domElement);

    const camera = new THREE.PerspectiveCamera(60, 1, 0.1, 2000);
    camera.position.set(0, 30, 65);
    camera.lookAt(0, 0, 0);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enablePan = false; controls.enableZoom = false; controls.enableRotate = false;

    function resize(){
      const w = root.clientWidth, h = root.clientHeight;
      renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
      renderer.setSize(w, h, false);
      camera.aspect = w / h; camera.updateProjectionMatrix();
    }
    window.addEventListener('resize', resize);
    resize();                         // <<< ensure first paint is valid
    renderer.render(scene, camera);   // <<< force first frame

    // Lights (brighter + ambient to avoid ‚Äúblack‚Äù PB materials)
    scene.add(new THREE.AmbientLight(0xffffff, 0.35));
    const hemi = new THREE.HemisphereLight(0xbdd9ff, 0x334455, 0.6); scene.add(hemi);
    const sun = new THREE.DirectionalLight(0xffffff, 1.0);
    sun.position.set(60, 120, 40); sun.castShadow = true;
    sun.shadow.mapSize.set(1024,1024);
    sun.shadow.camera.near = 10; sun.shadow.camera.far = 300;
    scene.add(sun);

    // Ground
    const groundMat = new THREE.MeshStandardMaterial({ color:0x2f3b2f, roughness:1 });
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(220, 220), groundMat);
    ground.rotation.x = -Math.PI/2; ground.receiveShadow = true; ground.position.y = 0;
    scene.add(ground);

    // Lake
    const lakeMat = new THREE.MeshPhysicalMaterial({ color:0x2a74b8, metalness:0.1, roughness:0.2, clearcoat:0.8 });
    const lake = new THREE.Mesh(new THREE.CircleGeometry(40, 40), lakeMat);
    lake.rotation.x = -Math.PI/2; lake.position.set(-40, 0.02, -10);
    scene.add(lake);

    // Helper toggles (hold Alt)
    let helperOn = false;
    function toggleHelpers(){
      helperOn = !helperOn;
      if (helperOn){
        const grid = new THREE.GridHelper(220, 22, 0x888888, 0x444444); grid.name='__grid__'; scene.add(grid);
        const axes = new THREE.AxesHelper(25); axes.name='__axes__'; scene.add(axes);
      } else {
        const g = scene.getObjectByName('__grid__'); if (g) scene.remove(g);
        const a = scene.getObjectByName('__axes__'); if (a) scene.remove(a);
      }
    }
    window.addEventListener('keydown', (e)=>{ if (e.altKey) toggleHelpers(); });

    // Reusable box
    function box(w,h,d,color){
      const m = new THREE.Mesh(
        new THREE.BoxGeometry(w,h,d),
        new THREE.MeshStandardMaterial({color, roughness:0.9, metalness:0})
      );
      m.castShadow = true; m.receiveShadow = true;
      return m;
    }

    // Cabins ‚Äî **visible fix**: lift to y = height/2
    const cabinSpots = {
      Bobcat:  new THREE.Vector3(-50, 0, -30),
      Eagle:   new THREE.Vector3( 50, 0, -30),
      Bull:    new THREE.Vector3(   0, 0, -50),
      Bass:    new THREE.Vector3(-35, 0,  25),
      Cheetah: new THREE.Vector3( 35, 0,  25),
    };
    const cabinColorsHex = Object.fromEntries(Object.entries(cabinColors).map(([k,v])=>[k,new THREE.Color(v).getHex()]));
    const cabins = {};
    for (const [name,pos] of Object.entries(cabinSpots)){
      const H = 10;
      const cabin = box(22, H, 16, cabinColorsHex[name]);
      cabin.position.set(pos.x, H/2, pos.z);   // <<< sit on ground, not sunk
      scene.add(cabin);
      cabins[name] = cabin;

      const pole = new THREE.Mesh(new THREE.CylinderGeometry(0.4,0.6,10,8), new THREE.MeshStandardMaterial({color:0x222}));
      pole.position.set(pos.x, 5, pos.z + 12); pole.castShadow = true; scene.add(pole);
    }

    // Props
    const mealTable = box(14,1,8,0xa13333); mealTable.position.set(-10,0.6,45); scene.add(mealTable);
    const waterSpout = box(3,6,3,0x3da5ff); waterSpout.position.set(-15,3,10); scene.add(waterSpout);
    const library = box(26,12,18,0x7a49ae); library.position.set(55,6,  5); scene.add(library);
    const shop = box(10,8,10,0x2b5f7a); shop.position.set(5,4,-5); scene.add(shop);
    const pit = box(30,2,30,0x202a32); pit.position.set(30,1,55); scene.add(pit);

    // Trees
    function addTree(x,z){
      const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.6,0.8,6,6), new THREE.MeshStandardMaterial({color:0x7a4f2b}));
      trunk.position.set(x,3,z); trunk.castShadow=true; scene.add(trunk);
      const leaves = new THREE.Mesh(new THREE.ConeGeometry(4,10,7), new THREE.MeshStandardMaterial({color:0x274f27, roughness:1}));
      leaves.position.set(x,11,z); leaves.castShadow=true; scene.add(leaves);
    }
    for (let i=0;i<24;i++){ addTree((Math.random()*180-90), (Math.random()*160-80)); }

    // Player
    const body = new THREE.Mesh(new THREE.CapsuleGeometry(2, 3, 8, 12), new THREE.MeshStandardMaterial({ color:0xf39c12 }));
    body.castShadow = true; body.position.set(0,3.5,0); scene.add(body);

    // Camera follow
    function followCamera(){
      const target = new THREE.Vector3(player.x, 3.0, player.z);
      const behind = new THREE.Vector3(Math.sin(player.rot), 0, Math.cos(player.rot)).multiplyScalar(-14);
      const eye = target.clone().add(new THREE.Vector3(0, 10, 0)).add(behind);
      camera.position.lerp(eye, 0.2);
      camera.lookAt(target);
    }

    // Movement
    const keys = {w:0,a:0,s:0,d:0};
    addEventListener('keydown',e=>{ if(e.key==='w')keys.w=1;if(e.key==='a')keys.a=1;if(e.key==='s')keys.s=1;if(e.key==='d')keys.d=1;if(e.key==='E'||e.key==='e')tryShop();});
    addEventListener('keyup',e=>{ if(e.key==='w')keys.w=0;if(e.key==='a')keys.a=0;if(e.key==='s')keys.s=0;if(e.key==='d')keys.d=0;});
    let velX=0, velZ=0;
    function stepMove(dt){
      const acc = 40, drag = 12, max = 18;
      const fwd = (keys.w - keys.s), str = (keys.d - keys.a);
      const sin = Math.sin(player.rot), cos = Math.cos(player.rot);
      const ix = (str*cos + fwd*sin), iz = (str*-sin + fwd*cos);
      velX += ix * acc * dt; velZ += iz * acc * dt;
      const spd = Math.hypot(velX, velZ);
      if (spd > max){ velX *= max/spd; velZ *= max/spd; }
      velX = THREE.MathUtils.damp(velX, 0, drag, dt);
      velZ = THREE.MathUtils.damp(velZ, 0, drag, dt);
      player.x += velX * dt; player.z += velZ * dt;
      player.x = Math.max(-105, Math.min(105, player.x));
      player.z = Math.max(-105, Math.min(105, player.z));
      if (Math.hypot(velX,velZ) > 0.3){ player.rot = Math.atan2(velX, velZ); }
      body.position.set(player.x, 3.5, player.z);
      body.rotation.y = player.rot;
    }

    // Day/Night
    const dayLen = 600;
    function applyDayNight(t){
      const k = Math.sin(t*Math.PI);
      sun.intensity = 0.3 + 0.9 * k;
      hemi.intensity = 0.4 + 0.4 * k;
      scene.background = new THREE.Color().setHSL(0.6, 0.6, 0.15 + 0.35*k);
    }

    // Gameplay
    const AABB = (obj, w, d)=> (player.x>obj.x-w && player.x<obj.x+w && player.z>obj.z-d && player.z<obj.z+d);
    const objPos = {
      lake: {x: lake.position.x, z: lake.position.z, w: 42, d: 42},
      spout:{x: waterSpout.position.x, z: waterSpout.position.z, w: 4, d: 4},
      library:{x: library.position.x, z: library.position.z, w: 14, d: 12},
      meal:{x: mealTable.position.x, z: mealTable.position.z, w: 10, d: 7},
      shop:{x: shop.position.x, z: shop.position.z, w: 8, d: 8},
      pit: {x: pit.position.x, z: pit.position.z, w: 14, d: 14},
    };

    const events = [
      { key:'heat', name:'Heat Wave', desc:'Thirst drains faster', start:60, end:160, thirstMul:1.8 },
      { key:'rain', name:'Rain', desc:'Thirst drains slower, hunger slightly faster', start:280, end:360, thirstMul:0.6, hungerMul:1.2 },
    ];
    function activeEvent(tSec){ return events.find(e => tSec>=e.start && tSec<=e.end) || null; }

    let quest = { key:'fetch_water', text:'Fetch water at the spout (stand next to it for 2s).', progress:0, done:false };
    let nearShop = false;
    function tryShop(){
      if (!nearShop) return;
      if (player.thirst < 80 && player.bullCoins >= 3){
        player.thirst = Math.min(100, player.thirst + 30); player.bullCoins -= 3; addCabinScore(player.cabin, 1, 'Hydration purchase');
      } else if (player.bullCoins >= 5){
        player.hunger = Math.min(100, player.hunger + 30); player.bullCoins -= 5; addCabinScore(player.cabin, 1, 'Snack purchase');
      }
      coinsEl.textContent = player.bullCoins|0; queueStateSend();
    }
    function updateHUD(){
      hungerEl.style.width = Math.max(0, player.hunger) + '%';
      thirstEl.style.width = Math.max(0, player.thirst) + '%';
      bathroomEl.style.width = Math.min(100, player.bathroom) + '%';
      coinsEl.textContent = player.bullCoins|0;
    }

    let cabinScores = { Bobcat:0, Eagle:0, Bull:0, Bass:0, Cheetah:0 };
    function renderScores(){
      scoreList.innerHTML = Object.entries(cabinScores).map(([k,v])=>`<div><b style="color:${cabinColors[k]}">${k}</b>: ${v|0}</div>`).join('');
    }
    function addCabinScore(cabin, amount){ if (!cabin) return; cabinScores[cabin] = (cabinScores[cabin]||0) + amount; renderScores(); if (ONLINE) updateDoc(doc(db, cabinsDocPath), { [cabin]: cabinScores[cabin] }).catch(()=>{}); }

    // Networking (throttled)
    let lastSend=0, sendEvery=140; let lastSnapshot = null;
    function queueStateSend(){
      const now = performance.now(); if (now - lastSend < sendEvery) return; lastSend = now;
      if (!ONLINE || !userId || !player.cabin) return;
      const ref = doc(db, playersCol, userId);
      const payload = { id:userId, x:player.x, z:player.z, rot:player.rot, hunger:player.hunger, thirst:player.thirst, bathroom:player.bathroom, bullCoins:player.bullCoins, cabin:player.cabin, username:player.username, ts: Date.now() };
      const str = JSON.stringify(payload); if (str === lastSnapshot) return; lastSnapshot = str;
      updateDoc(ref, payload).catch(()=>{ setDoc(ref, payload, { merge:true }).catch(()=>{}); });
    }

    // Chat
    let lastChatAt = 0;
    chatInput.addEventListener('keydown', async (e)=>{
      if (e.key !== 'Enter') return;
      const text = chatInput.value.trim(); if (!text) return;
      const now = Date.now(); if (now - lastChatAt < 1500) { chatInput.value=''; return; }
      lastChatAt = now; chatInput.value='';
      if (ONLINE){
        await addDoc(collection(db, chatCol), { uid:userId, name:player.username, cabin:player.cabin||'‚Äî', text, ts:serverTimestamp() }).catch(()=>{});
      } else {
        const line = document.createElement('div'); line.innerHTML = `<b>${player.username}</b> <span class="opacity-50">[${player.cabin||'‚Äî'}]</span>: ${text}`;
        chatLog.appendChild(line); chatLog.scrollTop = chatLog.scrollHeight;
      }
    });

    // Auth / Init
    async function boot(){
      document.getElementById('screens').style.display = 'block';
      show('loading');

      if (ONLINE){
        try{
          const app = initializeApp(firebaseConfig);
          auth = getAuth(); db = getFirestore();
          onAuthStateChanged(auth, async (u)=>{
            if (u){ userId = u.uid; player.id = userId; userIdEl.textContent = `User: ${userId.slice(0,6)}‚Ä¶`; await onlineInit(); }
            else {
              if (initialAuthToken){ try{ await signInWithCustomToken(auth, initialAuthToken); }catch{ await signInAnonymously(auth); } }
              else await signInAnonymously(auth);
            }
          });
        }catch{ userIdEl.textContent = 'Offline mode'; offlineInit(); }
      } else { userIdEl.textContent = 'Offline mode'; offlineInit(); }
    }
    async function onlineInit(){
      onSnapshot(doc(db, cabinsDocPath), (snap)=>{ if (snap.exists()){ cabinScores = { ...cabinScores, ...snap.data() }; renderScores(); }});
      onSnapshot(collection(db, playersCol), (snap)=>{
        snap.docChanges().forEach(ch=>{
          const d = ch.doc.data(); if (!d || d.id === userId) return;
          let other = others[d.id]; if (!other){ other = others[d.id] = { mesh:new THREE.Mesh(new THREE.CapsuleGeometry(2,3,8,12), new THREE.MeshStandardMaterial({ color: cabinColorsHex[d.cabin]||0x888888 })), state:{} }; other.mesh.castShadow=true; scene.add(other.mesh); }
          other.state = d; other.mesh.position.set(d.x||0, 3.5, d.z||0); other.mesh.material.color.set(cabinColors[d.cabin]||'#888');
        });
      });
      onSnapshot(query(collection(db, chatCol), orderBy('ts','desc'), limit(20)), (snap)=>{
        chatLog.innerHTML=''; const rows=[]; snap.forEach(doc=>rows.push(doc.data())); rows.reverse().forEach(m=>{ const line=document.createElement('div'); line.innerHTML=`<b>${m.name}</b> <span class="opacity-50">[${m.cabin}]</span>: ${m.text}`; chatLog.appendChild(line);}); chatLog.scrollTop = chatLog.scrollHeight;
      });
      const meRef = doc(db, playersCol, userId); const meSnap = await getDoc(meRef); if (!meSnap.exists()){ await setDoc(meRef, { ...player }, { merge:true }); }
      show('cutscene');
    }
    function offlineInit(){ renderScores(); show('cutscene'); }

    // Cabin selection
    document.getElementById('to-cabins').addEventListener('click', ()=> show('cabins'));
    document.querySelectorAll('#cabins .btn').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        player.cabin = btn.dataset.cabin;
        body.material.color.set(cabinColors[player.cabin]);
        document.getElementById('screens').style.display='none';
        addCabinScore(player.cabin, 1);
        player.x = 0; player.z = 0; body.position.set(0,3.5,0);
        if (ONLINE){ await setDoc(doc(db, playersCol, userId), { ...player }, { merge:true }).catch(()=>{}); }
      });
    });

    // Loop
    let last = performance.now(); let tDay = 0; let questHold = 0;
    function frame(now){
      const dt = Math.min(0.05, (now-last)/1000); last=now;
      tDay = (tDay + dt) % 600;
      applyDayNight(tDay/600);

      stepMove(dt);
      followCamera();

      // Needs
      let hungerMul = 0.18, thirstMul = 0.28, bathInc = 0.12;
      const ev = activeEvent(tDay);
      if (ev){ eventBanner.style.display='block'; eventBanner.textContent = `Event: ${ev.name} ‚Äî ${ev.desc}`; hungerMul *= ev.hungerMul || 1.0; thirstMul *= ev.thirstMul || 1.0; }
      else eventBanner.style.display='none';
      player.hunger = Math.max(0, player.hunger - hungerMul*100*dt/60);
      player.thirst = Math.max(0, player.thirst - thirstMul*100*dt/60);
      player.bathroom = Math.min(100, player.bathroom + bathInc*100*dt/60);

      // Interactions
      if (AABB(objPos.lake, 42, 42)) { player.bathroom = Math.min(100, player.bathroom + 20*dt); }
      if (AABB(objPos.spout, 4, 4))   { player.thirst = Math.min(100, player.thirst + 60*dt); questHold += dt; if (quest.key==='fetch_water' && !quest.done && questHold>=2){ quest.done=true; addCabinScore(player.cabin, 5); questText.textContent='Quest complete!'; } }
      else questHold = 0;
      if (AABB(objPos.library, 14, 12)){ player.bathroom = Math.max(0, player.bathroom - 120*dt); }
      if (AABB(objPos.meal, 10, 7))    { player.hunger = Math.min(100, player.hunger + 100*dt); }
      if (player.hunger<35 && player.thirst<35 && AABB(objPos.pit, 14, 14)){ player.bullCoins = Math.max(0, player.bullCoins - 10); }

      const near = AABB(objPos.shop, 8, 8);
      if (near && !nearShop){ shopTip.classList.remove('hidden'); }
      if (!near && nearShop){ shopTip.classList.add('hidden'); }
      nearShop = near;

      updateHUD();
      queueStateSend();

      renderer.render(scene, camera);
      requestAnimationFrame(frame);
    }

    // Initial quest text
    questText.textContent = 'Fetch water at the spout (stand next to it for 2s).';

    // Start
    boot();
    requestAnimationFrame(frame);
  </script>
</body>
</html>
